<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=no">
    <title>Batch Generator for training machine learning models</title>
    <link rel="icon" type="image/x-icon" href="/images/hsf_logo_angled.png">

    <!-- bootstrap framework -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/flatly/bootstrap.min.css">

    <link rel="stylesheet" href="/css/hsf.css" type="text/css" />
</head>
<body>

<div class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
          <a href="/" class="navbar-brand"><span class="glyphicon glyphicon-home"></span>&nbsp;&nbsp;HSF</a>
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
          <ul class="nav navbar-nav navbar-center">
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="wg_menu"><span class="glyphicon glyphicon-briefcase"></span>&nbsp;&nbsp;Working Groups<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="activities_menu">
                  <li><a href="/what_are_WGs.html">What are HSF working groups?</a></li>
                  <li class="divider"></li>
                  
                    <li><a href="/workinggroups/dataanalysis.html">Data Analysis</a></li>
                  
                    <li><a href="/workinggroups/detsim.html">Detector Simulation</a></li>
                  
                    <li><a href="/workinggroups/frameworks.html">Frameworks</a></li>
                  
                    <li><a href="/workinggroups/generators.html">Physics Generators</a></li>
                  
                    <li><a href="/workinggroups/juliahep.html">JuliaHEP - Julia in HEP</a></li>
                  
                    <li><a href="/workinggroups/pyhep.html">PyHEP - Python in HEP</a></li>
                  
                    <li><a href="/workinggroups/recotrigger.html">Reconstruction and Software Triggers</a></li>
                  
                    <li><a href="/workinggroups/toolsandpackaging.html">Software Developer Tools and Packaging</a></li>
                  
                    <li><a href="/workinggroups/training.html">HSF Training</a></li>
                  
               </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="activities_menu"><span class="glyphicon glyphicon-briefcase"></span>&nbsp;&nbsp;Activities<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="activities_menu">
                 <li><a href="/what_are_activities.html">What are HSF activity areas?</a></li>
                 <li class="divider"></li>
                 
                   <li><a href="/activities/analysisfacilitiesforum.html">Analysis Facilities Forum</a></li>
                 
                   <li><a href="/activities/conditionsdb.html">Conditions Databases</a></li>
                 
                   <li><a href="/activities/differentiablecomputing.html">Differentiable Computing</a></li>
                 
                   <li><a href="/activities/gsdocs.html">Season of Docs</a></li>
                 
                   <li><a href="/activities/gsoc.html">Google Summer of Code</a></li>
                 
                   <li><a href="/activities/idds.html">intelligent Data Delivery Service</a></li>
                 
                   <li><a href="/activities/licensing.html">Licensing</a></li>
                 
                   <li><a href="/activities/reviews.html">Reviews</a></li>
                 
                   <li><a href="/activities/visualization.html">Visualisation</a></li>
                 
               </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="meetings_menu"><span class="glyphicon glyphicon-phone-alt"></span>&nbsp;&nbsp;Meetings<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="activities_menu">
                 
                   <li><a href="/meetings/compute-accelerator-forum.html">Compute Accelerator Forum</a></li>
                 
                   <li><a href="/meetings/coordination.html">Coordination Meetings</a></li>
                 
                   <li><a href="/meetings/roundtable.html">Software and Computing Roundtable</a></li>
                 
                   <li><a href="/meetings/software-forum.html">Software Forum</a></li>
                 
               </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="communication_menu"><span class="glyphicon glyphicon-bullhorn"></span>&nbsp;&nbsp;Communication<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="communication_menu">
                  <li><a href="/future-events.html">Community Calendar</a></li>
                  <li><a href="https://indico.cern.ch/category/5816/" target="_hsf_indico">Meetings: Indico</a></li>
                  <li><a href="/Schools/events.html">Training Schools</a></li>
                  <li class="divider"></li>
                  <li><a href="/forums.html">Mailing Lists and Forums</a></li>
                  <li><a href="/organization/minutes.html">Meeting Notes</a></li>
                  <li><a href="/technical_notes.html">Technical Notes</a></li>
                  <li><a href="/organization/documents.html">Documents</a></li>
                  <li><a href="/material_for_presentations.html">Material for presentations</a></li>
                  <li class="divider"></li>
                  <li><a href="/newsletter.html">Newsletters</a></li>
                  <li><a href="/events.html">Events &amp; Workshops</a></li>
                  <li><a href="https://www.youtube.com/c/HEPSoftwareFoundation" target="_hsf_youtube">HSF on YouTube</a></li>
                  <li class="divider"></li>

                  <li><a href="/inventory/inventory.html">HSF Project Inventory</a></li>
                </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/projects.html" id="projects_menu"><span class="glyphicon glyphicon-road"></span>&nbsp;&nbsp;Projects &amp; Support<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="projects_menu">
                  <li><a href="/project_guidelines.html">How to join as a project</a></li>
                  <li><a href="/projects.html">Member Projects</a></li>
                  <li class="divider"></li>
                  <li><a href="/services.html">Development Services</a></li>
                </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="about_menu"><span class="glyphicon glyphicon-info-sign"></span>&nbsp;&nbsp;About<span class="caret"></span></a>
              <ul class="dropdown-menu" aria-labelledby="about_menu">
                <li><a href="/get_involved.html">Get involved!</a><li>
                <li><a href="/organization/team.html">The Coordination Team</a></li>
                <li><a href="/organization/planning/plan-of-work-2023.html">HSF Planning</a></li>
                <li class="divider"></li>
                <li><a href="/organization/goals.html">Goals of the HSF</a></li>
                <li><a href="/organization/cwp.html">Community White Paper</a></li>
                <li><a href="/organization/hsf-letters.html">Letters from the HSF</a></li>
                <li><a href="/organization/presentations.html">HSF Presentations</a></li>
                <li><a href="/organization/youtube.html">HSF YouTube Channel</a></li>
                <li class="divider"></li>
                <li><a href="/howto-website.html">Website Howto</a></li>
              </ul>
            </li>
          </ul>
        </div>
    </div>
</div>


<div class="container">

  <div class="PageNavigation">

  <!-- Note that page sorting is reverse time ordered, so "next" refers to the previous
       meeting in time and "previous" to the next one -->
  
   <p class="alignleft"><a href="/gsoc/blogs/2022/blog_Geant4_HarshilJani.html">&nbsp;&#8592; Geant4 - Performance Data Visualization using d3.js</a></p>
  

  
    <p class="alignright"><a href="/gsoc/blogs/2022/blog_PODIO_SoumilBaldota.html">Interfacing PODIO with Julia &#8594;&nbsp;</a></p>
  

</div>

<div style="clear: both;"></div>


<hr>

<div class="blog-header">
  <div class="row">
    
       
        <div class="col-md-3">
          <img src="/images/blog_authors/SanchiMittal.jpeg" alt=Sanchi Mittal width="100%" style="float:right">
        </div>
        <div class="col-md-9">
      
    
    <h1 class="blog-title">Batch Generator for training machine learning models</h1>
    </div>
  </div>
  <p class="blog-post-meta">02 Sep 2022 by <a href="/gsoc/blogs/2022/blog_ROOT_SanchiMittal.html">Sanchi Mittal</a></p>
</div>

<div class="row">
  <div class="col-sm-12 blog-main">

  <h1 id="sanchis-final-evaluation-blog-for-gsoc-2022">Sanchi’s Final Evaluation Blog for GSoC 2022</h1>

<p>Through this blog, I’ll be going over the work that I have done as a contributor for GSoC 2022 program with CERN-HSF under the project “ROOT - Machine Learning Developments : Batch Generator for training machine learning models”.</p>

<div align="center">
![CERN](/images/CERN-HSF-GSoC-logo.png){:height="100px"} Google Summer of Code 2022
</div>

<h2 id="introduction">Introduction</h2>
<p>I’m a recent Computer Science and Engineering graduate, who’d always had a keen sense of amazement for Physics and Science in general. That’s why, it was like a dream come true when I got this opportunity via Google Summer of Code to make a contribution towards the High Energy Physics experimentations and the study of the universe, while utilising the skills and knowledge of my domain, that is Computer Science.</p>

<h2 id="about-the-project-goals">About the Project Goals</h2>
<p>Toolkit for Multivariate Analysis (TMVA) is a multi-purpose machine learning toolkit integrated into the ROOT scientific software framework, used in many particle physics data analysis and applications. Since it is part of the ROOT data analysis framework, it comes with an automatically generated Python interface, which closely follows the C++ interface. The goal of this project is to develop a generator in C++ and Python to read data from the ROOT I/O and input them to the Python machine learning tools such as Tensorflow/Keras and PyTorch. The main aim of the generator is to efficiently input data from the ROOT I/O system to train machine learning models, and keep in memory only the data required to train a batch of events and not all the data set.</p>

<ul>
  <li><strong>Goals</strong>
    <ul>
      <li>Development of a Python generator for getting the data directly from a ROOT TTree using PyROOT interfaces with Documentation</li>
      <li>Integration with ROOT RDataFrame with Documentation</li>
      <li>Development of tests and tutorial example</li>
    </ul>
  </li>
</ul>

<h2 id="community-bonding-period">Community Bonding Period</h2>
<p>During the community bonding, I made sure to plan out the to-do’s for the project and discuss, modify and reiterate over my project ideas.  I familiarized myself with ROOT, TMVA, RDataFrame, RTensor, TTree and other needed data structures and tools via tutorials, to get a headstart before the coding period. After finalizing, I communicated the revised expected project goals and timeline to my mentors via a powerpoint presentation, and it was finalized to begin the coding.</p>

<h2 id="implementing-the-prototype">Implementing the Prototype</h2>
<p>It has been evident while working that this project for developing the Batch Generator is something experimental and would require researching into different approaches before implementing or directly packaging it into TMVA. Thus, I have been working in a stand-alone repository over <a href="https://github.com/tmvadnn/tmva-batch-generator">here</a>, where I made pull requests for the experimental prototype.</p>

<ol>
  <li>The first aim was to have a basic batch generator, for which I started with a for-loop in Python. This turned out to be both memory and time-inefficient.
    <ul>
      <li><a href="https://github.com/SanchiMittal/root/commit/8b63ff3d13acc385df064b970a84a198f69ba336">Link to Code</a></li>
    </ul>
  </li>
  <li>In the second approach, I decided to write a functor for the batch generator, while replacing the for-loop using the RTensor::Slice method. This made it time-efficient, but definitely data-copying still left it memory-inefficient.
    <ul>
      <li><a href="https://github.com/tmvadnn/tmva-batch-generator/pull/2/commits/34c6fd5e86dae48a2101ea4219b113e47c4729fb">Link to Code</a></li>
    </ul>
  </li>
  <li>In the third approach, I have replaced this slice method, removing the extra copying actions from the memory. I discovered that initializing the RTensor directly as a ‘view’ would help us achieve this goal.
 	- <a href="https://github.com/tmvadnn/tmva-batch-generator/pull/4/commits/94dcf93b8ee9f97b434fcacc1663a5c2171cbb9a">Link to Code</a></li>
  <li>The next approach is where I have further optimized the memory operations by replacing the AsTensor() method by a template functor, such that an RTensor can be created out of a TTree / RDataframe without the need to copy the data while creation of the batches.
    <ul>
      <li><a href="https://github.com/tmvadnn/tmva-batch-generator/pull/4/commits/93ec68c86f5e01be01eee2e84f77cf228a3ba31d">Link to Code</a></li>
    </ul>
  </li>
  <li>As a next step, I have eliminated the recursive nature of the generator template functor using an interesting approach of using column sequence as parameter pack, for which I have added a separate dataloader for conversion from RDataFrame to RTensor.
    <ul>
      <li><a href="https://github.com/tmvadnn/tmva-batch-generator/pull/4/commits/536ebf315c4187c461dd50a3f9a6bfb36b4d0907">Link to Code</a></li>
    </ul>
  </li>
  <li>Additional useful features like random_shuffle and drop_last for the DataLoader are also added that can be found below.
    <ul>
      <li><a href="https://github.com/tmvadnn/tmva-batch-generator/pull/4/commits/536ebf315c4187c461dd50a3f9a6bfb36b4d0907">Link to Code</a></li>
    </ul>
  </li>
  <li>After a satisfactory C++ implementation, I have integrated a generator header with a Python batch generator for creating numpy batches from RDataFrame.
    <ul>
      <li><a href="https://github.com/tmvadnn/tmva-batch-generator/pull/4/commits/3e4bbc77f80b407af6f8dedfa1abf57634dd706c">Link to Code</a></li>
    </ul>
  </li>
  <li>Using the Python Batch Generator, I have created a tutorial with Keras classification model. For more improvements and most updated versions the following link can be followed:
    <ul>
      <li><a href="https://github.com/tmvadnn/tmva-batch-generator/blob/experimental/prototype_experimental/bg_keras_exp.py">Link to Code</a></li>
    </ul>
  </li>
</ol>

<h2 id="future-scope">Future Scope</h2>
<p>It has been a great learning experience while working on the batch generator project. I plan on continuing to contribute for the improvement of this project in the future as well, some of the points under future scope are listed below:</p>
<ul>
  <li>Further optimization of the memory intensive code wherever possible.</li>
  <li>Facilitating multi-threading over GPUs.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>
<p>I would like to express my gratitude to my mentors <strong>Lorenzo Moneta, Omar Zapata, Sanjiban Sengupta and Sitong An</strong>, for they have been extremely supportive with guidance and helped me put my efforts into the right direction, since the beginning of the program.</p>

<p>You can find my final GSoC submission <a href="https://github.com/tmvadnn/tmva-batch-generator/wiki">here</a>. Also, I have been documenting my GSoC 2022 journey with CERN-HSF via blogs that can be found over <a href="https://sanchimittal.hashnode.dev/">here</a>.</p>

<p><strong>- Sanchi</strong></p>


   </div>
</div>


<br><br>
<hr>
<div class="footer fixed-bottom">
<a href="https://github.com/HSF/hsf.github.io/edit/main/_gsocblogs/2022/blog_ROOT_SanchiMittal.md"><i class="glyphicon glyphicon-wrench"></i> Improve this page. </a>
Thanks to <a href="https://pages.github.com/">GitHub Pages</a>, <a href="http://jekyllrb.com/">Jekyll</a> and <a href="http://getbootstrap.com/">Bootstrap</a>.
</div>

</div> <!-- container -->


<!-- Google Analytics -->

<!-- Google Analytics end -->

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</body>
</html>
