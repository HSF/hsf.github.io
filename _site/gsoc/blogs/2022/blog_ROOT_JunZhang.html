<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=no">
    <title>Optimize ROOT use of modules for large codebases</title>
    <link rel="icon" type="image/x-icon" href="/images/hsf_logo_angled.png">

    <!-- bootstrap framework -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/flatly/bootstrap.min.css">

    <link rel="stylesheet" href="/css/hsf.css" type="text/css" />
</head>
<body>

<div class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
          <a href="/" class="navbar-brand"><span class="glyphicon glyphicon-home"></span>&nbsp;&nbsp;HSF</a>
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
          <ul class="nav navbar-nav navbar-center">
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="wg_menu"><span class="glyphicon glyphicon-briefcase"></span>&nbsp;&nbsp;Working Groups<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="activities_menu">
                  <li><a href="/what_are_WGs.html">What are HSF working groups?</a></li>
                  <li class="divider"></li>
                  
                    <li><a href="/workinggroups/dataanalysis.html">Data Analysis</a></li>
                  
                    <li><a href="/workinggroups/detsim.html">Detector Simulation</a></li>
                  
                    <li><a href="/workinggroups/frameworks.html">Frameworks</a></li>
                  
                    <li><a href="/workinggroups/generators.html">Physics Generators</a></li>
                  
                    <li><a href="/workinggroups/juliahep.html">JuliaHEP - Julia in HEP</a></li>
                  
                    <li><a href="/workinggroups/pyhep.html">PyHEP - Python in HEP</a></li>
                  
                    <li><a href="/workinggroups/recotrigger.html">Reconstruction and Software Triggers</a></li>
                  
                    <li><a href="/workinggroups/toolsandpackaging.html">Software Developer Tools and Packaging</a></li>
                  
                    <li><a href="/workinggroups/training.html">HSF Training</a></li>
                  
               </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="activities_menu"><span class="glyphicon glyphicon-briefcase"></span>&nbsp;&nbsp;Activities<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="activities_menu">
                 <li><a href="/what_are_activities.html">What are HSF activity areas?</a></li>
                 <li class="divider"></li>
                 
                   <li><a href="/activities/analysisfacilitiesforum.html">Analysis Facilities Forum</a></li>
                 
                   <li><a href="/activities/conditionsdb.html">Conditions Databases</a></li>
                 
                   <li><a href="/activities/differentiablecomputing.html">Differentiable Computing</a></li>
                 
                   <li><a href="/activities/gsdocs.html">Season of Docs</a></li>
                 
                   <li><a href="/activities/gsoc.html">Google Summer of Code</a></li>
                 
                   <li><a href="/activities/idds.html">intelligent Data Delivery Service</a></li>
                 
                   <li><a href="/activities/licensing.html">Licensing</a></li>
                 
                   <li><a href="/activities/reviews.html">Reviews</a></li>
                 
                   <li><a href="/activities/visualization.html">Visualisation</a></li>
                 
               </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="meetings_menu"><span class="glyphicon glyphicon-phone-alt"></span>&nbsp;&nbsp;Meetings<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="activities_menu">
                 
                   <li><a href="/meetings/compute-accelerator-forum.html">Compute Accelerator Forum</a></li>
                 
                   <li><a href="/meetings/coordination.html">Coordination Meetings</a></li>
                 
                   <li><a href="/meetings/roundtable.html">Software and Computing Roundtable</a></li>
                 
                   <li><a href="/meetings/software-forum.html">Software Forum</a></li>
                 
               </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="communication_menu"><span class="glyphicon glyphicon-bullhorn"></span>&nbsp;&nbsp;Communication<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="communication_menu">
                  <li><a href="/future-events.html">Community Calendar</a></li>
                  <li><a href="https://indico.cern.ch/category/5816/" target="_hsf_indico">Meetings: Indico</a></li>
                  <li><a href="/Schools/events.html">Training Schools</a></li>
                  <li class="divider"></li>
                  <li><a href="/forums.html">Mailing Lists and Forums</a></li>
                  <li><a href="/organization/minutes.html">Meeting Notes</a></li>
                  <li><a href="/technical_notes.html">Technical Notes</a></li>
                  <li><a href="/organization/documents.html">Documents</a></li>
                  <li><a href="/material_for_presentations.html">Material for presentations</a></li>
                  <li class="divider"></li>
                  <li><a href="/newsletter.html">Newsletters</a></li>
                  <li><a href="/events.html">Events &amp; Workshops</a></li>
                  <li><a href="https://www.youtube.com/c/HEPSoftwareFoundation" target="_hsf_youtube">HSF on YouTube</a></li>
                  <li class="divider"></li>

                  <li><a href="/inventory/inventory.html">HSF Project Inventory</a></li>
                </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/projects.html" id="projects_menu"><span class="glyphicon glyphicon-road"></span>&nbsp;&nbsp;Projects &amp; Support<span class="caret"></span></a>
                <ul class="dropdown-menu" aria-labelledby="projects_menu">
                  <li><a href="/project_guidelines.html">How to join as a project</a></li>
                  <li><a href="/projects.html">Member Projects</a></li>
                  <li class="divider"></li>
                  <li><a href="/services.html">Development Services</a></li>
                </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="/index.html" id="about_menu"><span class="glyphicon glyphicon-info-sign"></span>&nbsp;&nbsp;About<span class="caret"></span></a>
              <ul class="dropdown-menu" aria-labelledby="about_menu">
                <li><a href="/get_involved.html">Get involved!</a><li>
                <li><a href="/organization/team.html">The Coordination Team</a></li>
                <li><a href="/organization/planning/plan-of-work-2023.html">HSF Planning</a></li>
                <li class="divider"></li>
                <li><a href="/organization/goals.html">Goals of the HSF</a></li>
                <li><a href="/organization/cwp.html">Community White Paper</a></li>
                <li><a href="/organization/hsf-letters.html">Letters from the HSF</a></li>
                <li><a href="/organization/presentations.html">HSF Presentations</a></li>
                <li><a href="/organization/youtube.html">HSF YouTube Channel</a></li>
                <li class="divider"></li>
                <li><a href="/howto-website.html">Website Howto</a></li>
              </ul>
            </li>
          </ul>
        </div>
    </div>
</div>


<div class="container">

  <div class="PageNavigation">

  <!-- Note that page sorting is reverse time ordered, so "next" refers to the previous
       meeting in time and "previous" to the next one -->
  
   <p class="alignleft"><a href="/gsoc/blogs/2022/blog_PODIO_SoumilBaldota.html">&nbsp;&#8592; Interfacing PODIO with Julia</a></p>
  

  
    <p class="alignright"><a href="/gsoc/blogs/2022/blog_CompilerResearch-ManishKausik.html">Add Initial Integration of Clad with Enzyme &#8594;&nbsp;</a></p>
  

</div>

<div style="clear: both;"></div>


<hr>

<div class="blog-header">
  <div class="row">
    
       
        <div class="col-md-3">
          <img src="/images/blog_authors/JunZhang.jpg" alt=Jun Zhang width="100%" style="float:right">
        </div>
        <div class="col-md-9">
      
    
    <h1 class="blog-title">Optimize ROOT use of modules for large codebases</h1>
    </div>
  </div>
  <p class="blog-post-meta">07 Sep 2022 by <a href="/gsoc/blogs/2022/blog_ROOT_JunZhang.html">Jun Zhang</a></p>
</div>

<div class="row">
  <div class="col-sm-12 blog-main">

  <h2 id="introduction">Introduction</h2>

<p>Hello everyone! My name’s Jun Zhang and I’m so glad to be here as a Google Summer of Code contributor this year! This is a report about the progress of my project and everything technical and non-technical I have learned in it.</p>

<p>Before we diving into my work, I would like to give you a brief introduction about what my project trying to do:
For some very large C++ projects, the compilation time becomes a huge pain. One major factor of this issue is <strong>redundant header parsing</strong>. (Imaging every time you do <code class="language-plaintext highlighter-rouge">#include "foo.h"</code>, it just copies and pastes everything and starts reparsing.) This is more problematic for systems such as <a href="https://github.com/root-project/root">ROOT</a> because the code is parsed at runtime. To solve this issue, we have adopted <a href="https://github.com/root-project/root/blob/master/README/README.CXXMODULES.md">Clang modules in ROOT</a>, which alleviates the problem to some extent. However, the current module integration also has its limitations. For example, one source of performance loss is the need for symbol lookups across a very large set of modules. Take the example below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root [0] edm::X;
</code></pre></div></div>

<p>When ROOT sees <code class="language-plaintext highlighter-rouge">edm</code>, it will immediately pull up all modules containing it, which is totally unnecessary since we only care about <code class="language-plaintext highlighter-rouge">X</code>. So my project this year is aiming to eliminate the unnecessary lookup for identifiers like a namespace to reduce memory pressure.</p>

<h2 id="the-work-i-have-done">The Work I have done</h2>

<p>At the very beginning of the project, I tried to eliminate all namespaces identifiers lookups as it’s the most straightforward idea. But we soon ran into some troubles. The problem is that we lost the ability to recognize identifiers inside those nested namespaces, which is a very common case:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nl">error:</span> <span class="n">no</span> <span class="n">member</span> <span class="n">named</span> <span class="err">'</span><span class="n">MakeTrivialDataFrame</span><span class="err">'</span> <span class="n">in</span> <span class="k">namespace</span> <span class="err">'</span><span class="n">ROOT</span><span class="o">::</span><span class="n">RDF</span><span class="err">'</span>
   <span class="k">auto</span> <span class="n">d_s</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">::</span><span class="n">RDF</span><span class="o">::</span><span class="n">MakeTrivialDataFrame</span><span class="p">(</span><span class="n">nEvents</span><span class="p">);</span>
              <span class="o">~~~~~~~~~~~^</span>
</code></pre></div></div>

<p>This failure looks hard to solve so I was thinking: Why not achieve our goals step by step and only take top-level namespaces into consideration? So I did. The test results look good but when it comes to the performance improvement, Ugh… the results doesn’t look very satisfying. The reason is simple, as there’re not too many top-level namespaces, so we can’t get a significant memory decrease.</p>

<p>We seem to touch some dark corners in ROOT and are trapped by the unfathomable semantics of C++. During that period, I explored many directions but none seems to work. My mentors and I had some deep discussions, and finally, we came to a new approach: If we cannot ignore those namespaces, why not create a new module that contains all namespaces forward declarations? Because the manually generated module just consists of forward declarations, it’s cheap to preload, and ROOT can have all essential knowledge about namespaces with it. So here’s the <a href="https://github.com/root-project/root/pull/10910">PR</a>. The performance improvement also looks very promising:</p>

<p><img src="https://user-images.githubusercontent.com/77525145/189374093-c6533aa4-8d58-49f1-8996-6605aef0da2b.png" alt="Performance results" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Singularity&gt; <span class="nv">ROOTDEBUG</span><span class="o">=</span>7 root.exe <span class="nt">-l</span> <span class="nt">-b</span> <span class="nt">-q</span> <span class="nv">$ROOTSYS</span>/tutorials/hsimple.C |&amp; <span class="nb">grep</span> <span class="s2">"Loading"</span> | <span class="nb">wc</span> <span class="nt">-l</span> <span class="c"># The mainline ROOT with CMSSW integration</span>
180
Singularity&gt; <span class="nv">ROOTDEBUG</span><span class="o">=</span>7 root.exe <span class="nt">-l</span> <span class="nt">-b</span> <span class="nt">-q</span> <span class="nv">$ROOTSYS</span>/tutorials/hsimple.C |&amp; <span class="nb">grep</span> <span class="s2">"Loading"</span> | <span class="nb">wc</span> <span class="nt">-l</span> <span class="c"># After applying our patch</span>
52
</code></pre></div></div>

<p>In short words, we successfully reduced the amount of memory in <code class="language-plaintext highlighter-rouge">CMSSW</code> by half (from 1.1GB to 600MB) for simple workflows like <code class="language-plaintext highlighter-rouge">hsimple.C</code>, and the modules we’re loading for it reduced from 180 to 52.</p>

<p>I also made some presentations about my work to the team, and they can be found in:</p>

<ul>
  <li><a href="https://compiler-research.org/assets/presentations/CaaS_Weekly_08_06_2022_Jun_Zhang_Optimize_ROOT_Use_Of_Modules_For_Large_Codebases.pdf">Road Map of Optimize ROOT Use of Modules For Large Codebases</a></li>
  <li><a href="https://compiler-research.org/assets/presentations/CaaS_Weekly_07_09_2022_Jun_Zhang_Current_Working_Status_of_Optimize_Modules_Usage_For_ROOT.pdf">Current Working Status of Optimize Modules Usage For Root</a></li>
</ul>

<h2 id="post-gsoc">Post GSoC</h2>

<p>However, it’s not enough. I have done some deep profiling about Clang, and found out the bottleneck:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% total        Total        Calls  Function
   99.3  444'432'413       74'169  main [4]
   92.3  412'998'941       29'027  llvm::SmallVectorBase::grow_pod(void*, unsigned long, unsigned long) [5]
   89.2  399'211'718        7'870  clang::CompilerInstance::loadModule(clang::SourceLocation, llvm::ArrayRef&lt;std::pair&lt;clang::IdentifierInfo*, clang::SourceLocation&gt; &gt;, clang::Module::NameVisibilityKind, bool) [6]
   89.2  399'058'838        7'644  clang::ASTReader::ReadAST(llvm::StringRef, clang::serialization::ModuleKind, clang::SourceLocation, unsigned int, llvm::SmallVectorImpl&lt;clang::ASTReader::ImportedSubmodule&gt;*) [7]
   88.8  397'250'710        8'023  cling::Interpreter::loadModule(clang::Module*, bool) [8]
   88.7  397'152'678        7'901  clang::Sema::ActOnModuleImport(clang::SourceLocation, clang::SourceLocation, clang::SourceLocation, llvm::ArrayRef&lt;std::pair&lt;clang::IdentifierInfo*, clang::SourceLocation&gt; &gt;) [9]
   84.0  376'053'039       12'354  TRint::TRint(char const*, int*, char**, void*, int, bool, bool) [10]

</code></pre></div></div>

<p>From the above, we can see the hottest method is <code class="language-plaintext highlighter-rouge">SmallVectorBase::grow_pod</code>. That is actually caused by a problematic model: Clang always preallocates a huge buffer that is enough to contain all <code class="language-plaintext highlighter-rouge">SourceLocation</code> in a module, even without use.</p>

<p>The easiest solution in our mind is: Can we just get rid of <code class="language-plaintext highlighter-rouge">SmallVector</code> and use some more suitable data structures? So we tried to <code class="language-plaintext highlighter-rouge">SparseVector</code> which behaves like a normal vector but saves more spaces when the elements are sparse. Unfortunately from the performance results we see almost no improvement and we didn’t have enough time to figure out why.</p>

<p>In conclusion, we pinpointed the real issue in Clang. Rather than trying to mitigate the problem on the side of ROOT, I’ve started to talk with Clang modules code owners and plan to continue the work and cooperate with the upstream to further improve modules in ROOT. Hopefully, we can solve this longstanding issue and make Clang better.</p>

<h2 id="other-work">Other work</h2>

<p>Except the modules work, I also done a significant contribution to <code class="language-plaintext highlighter-rouge">clang-repl</code>, which is an upstream version of ROOT’s core interpreter. I improved the correctness and reliability of <code class="language-plaintext highlighter-rouge">clang-repl</code> by fixing lots of bugs. I also added an initial implementation of the code undo feature. Here’re some noticeable patches:</p>

<ul>
  <li>https://reviews.llvm.org/D126781</li>
  <li>https://reviews.llvm.org/D126682</li>
  <li>https://reviews.llvm.org/D128782</li>
  <li>https://reviews.llvm.org/D130420</li>
  <li>https://reviews.llvm.org/D130831</li>
</ul>

<h2 id="its-not-just-about-code">It’s not just about code!</h2>

<p>During this summer, I have learned a lot about coding stuff, and enhanced my knowledge of C++ and compilers. However, I think the most crucial thing I have learned has nothing to do with programming itself.</p>

<p>Due to the huge legacy codebase and the complexity of C++ semantics itself, the knowledge dispersed between various people and teams. In order to solve the problems, instead of sitting at the desk spend all day coding and debugging, we need to look for the right communication channels to extract the knowledge and turn it into an acceptable solution.</p>

<p>So remember human beings are collective animals and it’s always better to work as a team!</p>

<h2 id="acknowledgment">Acknowledgment</h2>

<p>Here I would like to thank everyone that help me with my GSoC project. Especially Vassil, he’s not only an experienced programmer, but also a patient teacher and friend. He always gives me good ideas when I ran into some weird bugs, and provides useful suggestions for my career. I should also thanks David, who patiently helped me with the crazy CMSSW build infrastructure.</p>

<p>Thank you! &lt;3</p>

<p>~jun
:wq</p>


   </div>
</div>


<br><br>
<hr>
<div class="footer fixed-bottom">
<a href="https://github.com/HSF/hsf.github.io/edit/main/_gsocblogs/2022/blog_ROOT_JunZhang.md"><i class="glyphicon glyphicon-wrench"></i> Improve this page. </a>
Thanks to <a href="https://pages.github.com/">GitHub Pages</a>, <a href="http://jekyllrb.com/">Jekyll</a> and <a href="http://getbootstrap.com/">Bootstrap</a>.
</div>

</div> <!-- container -->


<!-- Google Analytics -->

<!-- Google Analytics end -->

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</body>
</html>
